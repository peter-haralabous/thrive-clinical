{% load i18n %}
{% load crispy_forms_tags %}
{% load lucide %}

<dialog id="preference-modal"
        class="modal"
        aria-labelledby="preference-modal-title"
        aria-modal="true">
  <div class="modal-box max-w-2xl">
    {% include "partials/modal_close_button.html" %}
    <h3 id="preference-modal-title" class="font-bold text-lg mb-2">
      {% if is_org_default %}
        {% trans "Organization Default Preferences" %}
      {% else %}
        {% trans "List Preferences" %}
      {% endif %}
    </h3>
    {% if is_org_default %}
      <p class="text-sm text-base-content/70 mb-4">
        {% trans "These preferences will be the default for all users in your organization unless they customize their own." %}
      </p>
    {% endif %}
    {% if not is_org_default and has_user_preference %}
      <div class="alert alert-info mb-4">
        {% lucide "info" class="stroke-current shrink-0 size-6" %}
        <span>{% trans "You have customized preferences. Click 'Reset to Defaults' to use organization defaults." %}</span>
      </div>
    {% endif %}
    <form hx-post="{% if is_org_default %}{% url 'providers:save_organization_preference' organization_id=organization.id list_type=list_type %}{% else %}{% url 'providers:save_list_preference' organization_id=organization.id list_type=list_type %}{% endif %}"
          hx-swap="none"
          class="space-y-6">
      {% csrf_token %}
      <div class="form-control" id="columns-section">
        <label class="label">
          <span class="label-text font-semibold">{% trans "Visible Columns" %}</span>
        </label>
        <label class="label">
          <span class="label-text-alt text-xs opacity-70">{% trans "Tip: Drag columns to reorder them in the table" %}</span>
        </label>
        <sortable-columns id="sortable-columns" columns-data='{{ columns_data_json|safe }}'></sortable-columns>
        <a href="{% url "providers:custom_attribute_list" organization_id=organization.id %}"
           class="btn w-full mt-2">{% lucide "plus" class="size-4" %} {% trans "Add or edit fields" %}</a>
      </div>
      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">{% trans "Default Sort" %}</span>
        </label>
        {{ form.default_sort }}
      </div>
      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">{% trans "Items per page" %}</span>
        </label>
        {{ form.items_per_page }}
      </div>
      <div class="modal-action">
        {% if is_org_default and preference and preference.scope == "organization" %}
          <button type="button"
                  hx-post="{% url 'providers:reset_organization_preference' organization_id=organization.id list_type=list_type %}"
                  hx-swap="none"
                  class="btn btn-ghost">{% trans "Reset to System Defaults" %}</button>
        {% endif %}
        {% if not is_org_default and has_user_preference %}
          <button type="button"
                  hx-post="{% url 'providers:reset_list_preference' organization_id=organization.id list_type=list_type %}"
                  hx-swap="none"
                  class="btn btn-ghost">{% trans "Reset to Defaults" %}</button>
        {% endif %}
        <form method="dialog">
          <button class="btn">{% trans "Cancel" %}</button>
        </form>
        <button type="submit" class="btn btn-primary">
          {% if is_org_default %}
            {% trans "Save Organization Defaults" %}
          {% else %}
            {% trans "Save Preferences" %}
          {% endif %}
        </button>
      </div>
    </form>
  </div>
  <form method="dialog"
        class="modal-backdrop"
        aria-label="Close preferences modal">
    <button aria-label="Close">close</button>
  </form>
</dialog>
<script>
  document.getElementById("preference-modal").showModal()
</script>
