{% load lucide %}

{% if query %}
  {% if context == "encounter_create" %}
    {# Command palette context - use HTMX to load modal #}
    {% for patient in patients %}
      <li>
        <a href="#"
           hx-get="{% url 'providers:encounter_create_select_patient' organization_id=organization.id patient_id=patient.id %}"
           hx-target="#modal-container"
           hx-swap="innerHTML">
          <div>
            {% lucide "user" class="result-icon-left" %}
            <div class="result-content">
              <div class="result-title">{{ patient.last_name }}, {{ patient.first_name }}</div>
              <div class="result-subtitle">
                DOB: {{ patient.date_of_birth|date:"M d, Y"|default:"None" }} • PHN: {{ patient.phn|default:"None" }}
              </div>
            </div>
            {% lucide "chevron-right" class="result-icon" %}
          </div>
        </a>
      </li>
    {% endfor %}
    <li>
      <a href="{% url 'providers:patient_add' organization_id=organization.id %}?maybe_name={{ query|urlencode }}&return_url={% url 'providers:encounter_list' organization_id=organization.id %}?open_encounter_modal=1">
        <div>
          {% lucide "user-plus" class="result-icon-left" %}
          <div class="result-content">
            <div class="result-title">Create patient "{{ query }}"</div>
          </div>
          {% lucide "chevron-right" class="result-icon" %}
        </div>
      </a>
    </li>
  {% else %}
    {# Traditional page context - use button handlers #}
    <div class="dropdown dropdown-open w-full">
      <ul class="dropdown-content bg-base-100 rounded-box w-full shadow-lg border border-base-300 max-h-60 overflow-y-auto">
        {% for patient in patients %}
          <li>
            <button type="button"
                    class="patient-select-btn flex justify-between items-center w-full p-3 hover:bg-base-200 cursor-pointer border-b border-base-300 last:border-b-0"
                    data-patient-id="{{ patient.id }}"
                    data-patient-name="{{ patient.last_name }}, {{ patient.first_name }}"
                    data-patient-email="{{ patient.email }}"
                    data-patient-dob="{{ patient.date_of_birth|date:'M d, Y' }}"
                    data-patient-phn="{{ patient.phn }}">
              <div class="flex items-center gap-3 text-left">
                {% lucide "user" class="w-4 h-4 text-base-content/60 flex-shrink-0" %}
                <div>
                  <div class="font-medium">{{ patient.last_name }}, {{ patient.first_name }}</div>
                  <div class="text-sm text-base-content/70">{{ patient.email }}</div>
                  <div class="text-sm text-base-content/70">
                    DOB: {{ patient.date_of_birth|date:"M d, Y"|default:"None" }} • PHN: {{ patient.phn|default:"None" }}
                  </div>
                </div>
              </div>
              {% lucide "chevron-right" class="w-4 h-4 text-base-content/40" %}
            </button>
          </li>
        {% endfor %}
        <li>
          <a class="patient-create-btn flex justify-between items-center w-full p-3 hover:bg-base-200 cursor-pointer border-b border-base-300 last:border-b-0"
             data-organization-id="{{ organization.id }}">
            <div class="flex items-center gap-3 text-left">
              {% lucide "user-plus" class="w-4 h-4 text-base-content/60 flex-shrink-0" %}
              <div class="font-medium">Create patient "{{ query }}"</div>
            </div>
            {% lucide "chevron-right" class="w-4 h-4 text-base-content/40" %}
          </a>
        </li>
      </ul>
    </div>
  {% endif %}
{% endif %}
