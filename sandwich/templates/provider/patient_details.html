{% extends "provider/base.html" %}

{% load crispy_forms_tags %}
{% load lucide %}

{% block content %}
  <a class="inline-flex items-center gap-2 text-gray-800 mb-6 link"
     href="{% url "providers:encounter_list" organization_id=organization.id %}">
    {% lucide "chevron-left" class="size-4" %}
    <span>Encounters list</span>
  </a>
  <div class="flex flex-row items-start justify-between w-full space-y-4 card card-border bg-base-100 px-6 py-4 mb-4">
    <div>
      <h1>{{ patient.last_name }}, {{ patient.first_name }}</h1>
      <p class="text-sm tracking-wide flex gap-6 mt-2 items-center">
        <span class="flex items-center gap-1">{% lucide "calendar" class="size-4" %} DOB: {{ patient.date_of_birth|date:DJANGO_DATE_FORMAT }} </span>
        <span class="flex items-center gap-1">{% lucide "id-card" class="size-4" %} PHN: {{ patient.phn|default:EMPTY_VALUE_DISPLAY }}</span>
        <span class="flex items-center gap-1">{% lucide "info" class="size-4" %} Contact: {{ patient.email|default:EMPTY_VALUE_DISPLAY }}</span>
      </p>
    </div>
    <div>{% include 'provider/partials/patient_details_action_menu.html' %}</div>
  </div>
  {% if pending_invitation %}
    <div class="card card-border bg-base-100 px-6 py-4 space-y-2 mb-6">
      <h2 class="m-0">Invitation</h2>
      <p>
        <strong>Status:</strong> {{ pending_invitation.get_status_display }}, last sent at {{ pending_invitation.last_invited_at }}
      </p>
      <form action="{% url "providers:patient_resend_invite" organization_id=organization.id patient_id=patient.id %}"
            class="inline"
            method="post">
        {% csrf_token %}
        <button type="submit" class="btn btn-outline-primary">Resend Invitation</button>
      </form>
    </div>
  {% endif %}
  <div class="flex justify-between items-center mb-4">
    <h3 class="m-0">Encounters</h3>
    <form action="{% url "providers:patient_add_encounter" organization_id=organization.id patient_id=patient.id %}"
          class="inline"
          method="post">
      {% csrf_token %}
      <button type="submit"
              class="btn {% if current_encounter %}{% else %}btn-primary{% endif %}">Start a New Encounter</button>
    </form>
  </div>
  <div class="overflow-x-auto rounded-box border border-base-200 bg-base-100">
    <table class="table">
      <thead>
        <tr>
          <th>Started</th>
          <th>Ended</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        {% for encounter in encounters %}
          <tr>
            <td>{{ encounter.created_at|date:DJANGO_DATE_TIME_FORMAT }}</td>
            <td>{{ encounter.ended_at|date:DJANGO_DATE_TIME_FORMAT|default:EMPTY_VALUE_DISPLAY }}</td>
            <td>
              {% if encounter.active %}
                <span class="badge badge-md badge-success">Active</span>
              {% else %}
                <span class="badge badge-md badge-error">Archived</span>
              {% endif %}
            </td>
            <td class="text-right">
              <a class="btn btn-sm"
                 href="{% url "providers:encounter" encounter_id=encounter.id organization_id=organization.id %}">Details</a>
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="4" class="text-center">No encounters.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="mt-6 space-y-6">
    {% include 'provider/partials/summaries_section.html' %}
    {% include 'provider/partials/forms_section.html' %}
  </div>
{% endblock content %}
