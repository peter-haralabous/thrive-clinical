{% extends "patient/base.html" %}

{% load heroicons %}

{% block content %}
  <h1 class="mb-4">My Health Records</h1>
  {% include "patient/partials/personal_information.html" with patient=patient %}
  {% include "patient/partials/card_conditions.html" with category="Conditions" facts=facts.conditions %}
  {% include "patient/partials/card_symptoms.html" with category="Symptoms" facts=facts.symptoms %}
  {% include "patient/partials/card_medications.html" with category="Medications" facts=facts.medications %}
  {% include "patient/partials/card_allergies.html" with category="Allergies" facts=facts.allergies %}
  {% include "patient/partials/card_hospital_visits.html" with category="Hospital Visits" facts=facts.hospital_visits %}
  {% include "patient/partials/card_injuries.html" with category="Injuries" facts=facts.injuries %}
  {% include "patient/partials/card_practitioners.html" with category="Practitioners" facts=facts.practitioners %}
  {% include "patient/partials/card_lab_results.html" with category="Lab Results" facts=facts.lab_results %}
  {% include "patient/partials/card_immunizations.html" with category="Immunizations" facts=facts.immunizations %}
  {% include "patient/partials/card_procedures.html" with category="Procedures" facts=facts.procedures %}
  {% include "patient/partials/card_family_history.html" with category="Family History" facts=facts.family_history %}
  {% include "patient/partials/card_documents_and_notes.html" with category="Documents and Notes" facts=facts.documents_and_notes %}
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mt-8 mb-6">
    <div class="flex items-center gap-3">
      <span class="text-lg font-semibold">Documents</span>
      <span class="badge badge-info badge-outline text-xs">PDF upload will extract clinical facts automatically</span>
    </div>
    <div class="flex items-center gap-2">
      <button id="upload-btn"
              type="button"
              class="btn btn-primary btn-sm flex items-center gap-1">
        {% heroicon_outline "arrow-up-on-square" class="size-4" %}
        Upload
      </button>
      <form id="upload-form"
            method="post"
            action="{% url 'patients:document_upload_and_extract' patient_id=patient.id %}"
            hx-post="{% url 'patients:document_upload_and_extract' patient_id=patient.id %}"
            hx-target="#documents-table-container"
            hx-encoding="multipart/form-data"
            class="hidden">
        <input type="file" id="file-input" name="file" accept="application/pdf" />
        {% csrf_token %}
      </form>
    </div>
  </div>
  <div id="documents-table-container">{% include "patient/partials/documents_table.html" %}</div>
  <script nonce="{{ request.csp_nonce }}">
    document.getElementById('upload-btn').addEventListener('click', () => {
      document.getElementById('file-input').click()
    });
    document.getElementById('file-input').addEventListener('change', () => {
      document.getElementById('upload-form').requestSubmit();
    });

    // Visual feedback for drag events
    const tableContainer = document.getElementById('documents-table-container');
    tableContainer.addEventListener('dragover', e => {
      e.preventDefault();
      tableContainer.children[0].classList.add('border-primary', 'bg-base-300');
    });
    tableContainer.addEventListener('dragleave', e => {
      e.preventDefault();
      tableContainer.children[0].classList.remove('border-primary', 'bg-base-300');
    });
    tableContainer.addEventListener('drop', e => {
      e.preventDefault();
      tableContainer.children[0].classList.remove('border-primary', 'bg-base-300');
      const files = e.dataTransfer.files;
      if (!files.length) return;
      const file = files[0];
      if (file.type !== 'application/pdf') {
        // TODO: add javascript interface for showing toast messages
        alert("Only PDF files are supported.");
        return;
      }
      const fileInput = document.getElementById('file-input');
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(file);
      fileInput.files = dataTransfer.files;
      document.getElementById('upload-form').requestSubmit();
    });
  </script>
  {# NOTE: tasks are only relevant if this patient is linked with an organization #}
  {% if tasks %}
    <h3 class="my-4">Tasks</h3>
    <div class="flex space-y-4 flex-col">
      {% for task in tasks %}
        <div class="card card-border bg-base-100 w-full">
          <div class="card-body">
            <h2 class="card-title">{{ task.name }}</h2>
            {% if task.active %}
              <div class="badge badge-outline badge-success">Active</div>
            {% else %}
              <div class="badge badge-outline badge-error">Inactive</div>
            {% endif %}
            <p>Assigned on {{ task.created_at }}</p>
            {% if task.ended_at %}<p>Completed on {{ task.ended_at }}</p>{% endif %}
            <div class="card-actions justify-end">
              <a href="{% url "patients:task" patient_id=task.patient_id task_id=task.id %}"
                 class="btn btn-primary">Go to
              task</a>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endblock content %}
