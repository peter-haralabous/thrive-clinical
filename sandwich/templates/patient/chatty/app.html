{% extends "base_top_nav.html" %}

{% load crispy_forms_tags %}
{% load lucide %}

{% block topnav %}
  {% comment %} Your existing topnav include {% endcomment %}
  {% include 'patient/chatty/partials/topnav.html' %}
{% endblock topnav %}
{% block content %}
  {# the sse-swap here is misleading -- the messages themselves have hx-swap-oob set to their actual target #}
  <div sse-connect="{% url "core:events" %}?channel=patient/{{ patient.id }}"
       sse-swap="ingest_progress"></div>
  <form id="global-upload-form"
        method="post"
        action="{% url 'patients:document_upload_and_extract' patient_id=patient.id %}"
        hx-post="{% url 'patients:document_upload_and_extract' patient_id=patient.id %}"
        hx-encoding="multipart/form-data"
        class="hidden">
    <input type="file" name="file" accept="application/pdf, text/plain" multiple />
    {% csrf_token %}
  </form>
  <div id="global-upload-hover"
       class="fixed inset-2 rounded-xl pointer-events-none z-50 border-4 border-dashed border-transparent transition-all">
  </div>
  {# pb-16 is an approximation of #mobile-nav's height. #}
  <div class="flex flex-row flex-1 gap-2 h-full pb-16 lg:pb-0">
    {% comment %} Left Panel {% endcomment %}
    <div id="mobile-records-view" class="w-full lg:w-auto lg:contents">
      {% block left_panel %}
        {% include 'patient/chatty/partials/left_panel.html' %}
      {% endblock left_panel %}
    </div>
    {% comment %} Center Panel {% endcomment %}
    <div id="mobile-chat-view"
         class="w-full lg:w-auto lg:flex-1 flex flex-col h-full bg-base-100 rounded-xl border border-base-300">
      <header class="navbar bg-base-100 border-b rounded-t-xl">
        <div class="flex-none pl-2">{% lucide "sparkles" class="size-6" %}</div>
        <div class="flex-1 px-2">
          <span class="font-semibold text-lg">Assistant</span>
        </div>
      </header>
      <main id="chat-messages" class="flex-1 overflow-y-auto p-4">
        <template id="user-message-template" class="hidden">
          {% include "patient/chatty/partials/user_message.html" %}
        </template>
        {% with message="Here are a few things you could do..." %}
          {% include "patient/chatty/partials/user_message.html" %}
        {% endwith %}
        {% with message="Your last recorded HbA1c and Cholesterol results are from May 2023. Would you like to add any more recent lab results?" %}
          {% include "patient/chatty/partials/assistant_message.html" %}
        {% endwith %}
      </main>
      <footer class="p-4 bg-base-100 border-t border-base-300 rounded-b-xl flex justify-center">
        <div class="w-full max-w-4xl">
          <div class="relative">{% crispy chat_form %}</div>
          <div class="flex justify-between items-center mt-2 px-2">
            <div class="flex gap-2">
              <button class="btn btn-ghost btn-sm btn-circle">{% lucide "paperclip" class="size-5" %}</button>
              <button class="btn btn-ghost btn-sm btn-circle">{% lucide "share" class="size-5" %}</button>
            </div>
            <p class="text-xs text-base-content/50">
              HealthConnect can make mistakes. Double check with a health professional you trust.
            </p>
          </div>
        </div>
      </footer>
    </div>
    <div id="mobile-feed-view" class="w-full lg:w-auto lg:contents">
      {% include 'patient/chatty/partials/right_panel.html' %}
    </div>
  </div>
  {% comment %} Mobile Navigation {% endcomment %}
  <nav id="mobile-nav"
       class="lg:hidden fixed bottom-0 left-0 right-0 bg-base-100 border-t border-base-300 flex justify-around shadow-[0_-2px_10px_rgba(0,0,0,0.05)]">
    <button data-view="records"
            class="mobile-nav-item flex flex-col items-center justify-center flex-1 py-2 transition-colors text-base-content/60 hover:text-primary">
      <div class="relative">
        {% lucide "heart-pulse" class="size-6" %}
        {# <span class="absolute -top-1 -right-1 flex h-4 w-4 items-center justify-center rounded-full bg-primary text-primary-content text-xs font-semibold"></span> #}
      </div>
      <span class="text-xs font-medium mt-1">Records</span>
    </button>
    <button data-view="chat"
            class="mobile-nav-item flex flex-col items-center justify-center flex-1 py-2 transition-colors text-primary">
      <div class="relative">{% lucide "sparkles" class="size-6" %}</div>
      <span class="text-xs font-bold mt-1">Assistant</span>
    </button>
    <button data-view="feed"
            class="mobile-nav-item flex flex-col items-center justify-center flex-1 py-2 transition-colors text-base-content/60 hover:text-primary">
      <div class="relative">{% lucide "layout-grid" class="size-6" %}</div>
      <span class="text-xs font-medium mt-1">Feed</span>
    </button>
  </nav>
  <script nonce="{{ request.csp_nonce }}">
    // Wait for the document to be ready
    document.addEventListener('DOMContentLoaded', () => {

      // Get all the elements
      const leftPanel = document.getElementById('left-panel');
      const leftPanelCollapsed = document.getElementById('left-panel-collapsed');
      const collapseLeftBtn = document.getElementById('collapse-left-btn');
      const expandLeftBtn = document.getElementById('expand-left-btn');

      const chatPanel = document.getElementById('mobile-chat-view');
      const chatMessages = chatPanel.querySelector('#chat-messages');
      const chatInput = chatPanel.querySelector("textarea");
      const chatUserMessageTemplate = chatPanel.querySelector('#user-message-template');
      const chatSubmit = chatPanel.querySelector('#button-id-submit');

      const rightPanel = document.getElementById('right-panel');
      const rightPanelCollapsed = document.getElementById('right-panel-collapsed');
      const collapseRightBtn = document.getElementById('collapse-right-btn');
      const expandRightBtn = document.getElementById('expand-right-btn');

      // Left Panel Listeners
      if (collapseLeftBtn) {
        collapseLeftBtn.addEventListener('click', () => {
          leftPanel.classList.add('hidden');
          leftPanelCollapsed.classList.remove('hidden');
          leftPanelCollapsed.classList.add('flex');
        });
      }

      if (expandLeftBtn) {
        expandLeftBtn.addEventListener('click', () => {
          leftPanel.classList.remove('hidden');
          leftPanelCollapsed.classList.add('hidden');
          leftPanelCollapsed.classList.remove('flex');
        });
      }

      // Right Panel Listeners
      if (collapseRightBtn) {
        collapseRightBtn.addEventListener('click', () => {
          rightPanel.classList.add('hidden');
          rightPanelCollapsed.classList.remove('hidden');
          rightPanelCollapsed.classList.add('flex');
        });
      }

      if (expandRightBtn) {
        expandRightBtn.addEventListener('click', () => {
          rightPanel.classList.remove('hidden');
          rightPanelCollapsed.classList.add('hidden');
          rightPanelCollapsed.classList.remove('flex');
        });
      }

      // Auto-resizing textarea
      if (chatInput) {
        chatInput.addEventListener('input', () => {
          chatInput.style.height = 'auto';
          chatInput.style.height = `${chatInput.scrollHeight}px`;
        });
      }

      // Mobile navigation
      const mobileNavItems = document.querySelectorAll('.mobile-nav-item');
      const mobileViews = {
        records: document.getElementById('mobile-records-view'),
        chat: document.getElementById('mobile-chat-view'),
        feed: document.getElementById('mobile-feed-view'),
      };

      function setActiveView(viewName) {
        // Update view visibility
        Object.values(mobileViews).forEach(view => view.classList.add('hidden'));
        if (mobileViews[viewName]) {
          mobileViews[viewName].classList.remove('hidden');
        }

        // Update nav item styles
        mobileNavItems.forEach(item => {
          const itemView = item.dataset.view;
          const label = item.querySelector('span');
          if (itemView === viewName) {
            item.classList.remove('text-base-content/60');
            item.classList.add('text-primary');
            label.classList.add('font-bold');
          } else {
            item.classList.add('text-base-content/60');
            item.classList.remove('text-primary');
            label.classList.remove('font-bold');
          }
        });
      }

      function handleResize() {
        if (window.innerWidth < 1024) {
          // Find the active view from the nav bar or default to 'chat'
          const activeItem = document.querySelector('.mobile-nav-item.text-primary');
          const activeView = activeItem ? activeItem.dataset.view : 'chat';
          setActiveView(activeView);
        } else {
          // On desktop, show all views
          Object.values(mobileViews).forEach(view => view.classList.remove('hidden'));
        }
      }

      mobileNavItems.forEach(item => {
        item.addEventListener('click', () => {
          setActiveView(item.dataset.view);
        });
      });

      // Define handlers for chat form
      chatSubmit.addEventListener('htmx:beforeRequest', function(event) {
        const message = chatInput.value.trim();
        if (message) {
          addUserMessage(message);
          chatInputReset();
        } else {
          event.preventDefault(); // Cancel the request
        }
      });

      function addUserMessage(text) {
        const clone = document.importNode(chatUserMessageTemplate.content, true);
        clone.querySelector('.user-message-content').textContent = text;
        chatMessages.appendChild(clone);
      }

      function chatInputReset() {
        chatInput.value = '';
        chatInput.style.height = 'auto';
        // Scroll to bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      const hoverIndicator = document.getElementById('global-upload-hover');
      const uploadForm = document.getElementById('global-upload-form');
      const fileInput = uploadForm.querySelector('input');

      // Drag and drop events for the whole window
      window.addEventListener('dragover', e => {
        e.preventDefault();
        hoverIndicator.classList.add('border-primary', 'bg-base-300/50');
        hoverIndicator.classList.remove('border-transparent');
      });
      window.addEventListener('dragleave', e => {
        e.preventDefault();
        hoverIndicator.classList.remove('border-primary', 'bg-base-300/50');
        hoverIndicator.classList.add('border-transparent');
      });
      window.addEventListener('drop', e => {
        e.preventDefault();
        hoverIndicator.classList.remove('border-primary', 'bg-base-300/50');
        hoverIndicator.classList.add('border-transparent');
        const files = e.dataTransfer.files;
        if (!files.length) return;
        const validFiles = Array.from(files).filter(file => ["application/pdf", "text/plain"].includes(file.type));
        if (validFiles.length < files.length) {
          // TODO: add javascript interface for showing toast messages
          alert("Unsupported file type. Please upload a PDF or plain text file.");
          return;
        }
        const dataTransfer = new DataTransfer();
        validFiles.forEach(file => dataTransfer.items.add(file));
        fileInput.files = dataTransfer.files;
        uploadForm.requestSubmit();
      });
      // Manual file selection (optional: add a button if desired)
      fileInput.addEventListener('change', () => {
        uploadForm.requestSubmit();
      });

      // Set initial state on load and on resize
      window.addEventListener('resize', handleResize);
      handleResize(); // Call on initial load
    });
  </script>
{% endblock content %}
