{% extends "base.html" %}

{% load crispy_forms_tags %}
{% load lucide %}

{% block body %}
  <div class="grid grid-rows-[auto_1fr_auto] h-screen">
    {% include 'patient/chatty/partials/topnav.html' %}
    <div class="overflow-hidden">
      {# the sse-swap here is misleading; ingest_progress messages include a hx-swap-oob with their real target #}
      <div sse-connect="{% url "core:events" %}?channel=patient/{{ patient.id }}"
           sse-swap="ingest_progress"></div>
      <div class="flex flex-row gap-2 p-1 lg:p-6 h-full">
        {# Left Panel #}
        {% block left_panel %}
          {% include 'patient/chatty/partials/left_panel.html' %}
        {% endblock left_panel %}
        {# Center Panel #}
        <div id="mobile-chat-view"
             class="w-full lg:w-auto lg:flex-1 flex flex-col h-full bg-base-100 rounded-xl border border-base-300">
          <header class="navbar bg-base-100 border-b rounded-t-xl">
            <div class="flex-none pl-2">{% lucide "sparkles" class="size-6" %}</div>
            <div class="flex-1 px-2">
              <span class="font-semibold text-lg">Assistant</span>
            </div>
          </header>
          <main id="chat-messages" class="flex-1 overflow-y-auto h-full p-4">
            <template id="user-message-template" class="hidden">
              {% include "patient/chatty/partials/user_message.html" %}
            </template>
            {% for message in chat_messages %}{{ message }}{% endfor %}
          </main>
          <footer class="p-4 bg-base-100 border-t border-base-300 rounded-b-xl flex justify-center">
            <div class="w-full max-w-4xl">
              <div class="relative">{% crispy chat_form %}</div>
              <div class="flex justify-between items-center mt-2 gap-2">
                <button id="chat-attach" class="btn btn-ghost btn-sm btn-circle">{% lucide "paperclip" class="size-5" %}</button>
                <p class="text-xs text-base-content/50">
                  HealthConnect can make mistakes. Double check with a health professional you trust.
                </p>
              </div>
            </div>
          </footer>
        </div>
        {# Right Panel #}
        {% include 'patient/chatty/partials/right_panel.html' %}
      </div>
    </div>
    {# Mobile Navigation #}
    <nav id="mobile-nav"
         class="lg:hidden bg-base-100 border-t border-base-300 flex justify-around shadow-[0_-2px_10px_rgba(0,0,0,0.05)]">
      <button data-view="records"
              class="mobile-nav-item flex flex-col items-center justify-center flex-1 py-2 transition-colors text-base-content/60 hover:text-primary">
        <div class="relative">{% lucide "heart-pulse" class="size-6" %}</div>
        <span class="text-xs font-medium mt-1">Records</span>
      </button>
      <button data-view="chat"
              class="mobile-nav-item flex flex-col items-center justify-center flex-1 py-2 transition-colors text-primary">
        <div class="relative">{% lucide "sparkles" class="size-6" %}</div>
        <span class="text-xs font-bold mt-1">Assistant</span>
      </button>
      <button data-view="feed"
              class="mobile-nav-item flex flex-col items-center justify-center flex-1 py-2 transition-colors text-base-content/60 hover:text-primary">
        <div class="relative">{% lucide "layout-grid" class="size-6" %}</div>
        <span class="text-xs font-medium mt-1">Feed</span>
      </button>
    </nav>
    <form id="global-upload-form"
          method="post"
          action="{% url 'patients:document_upload_and_extract' patient_id=patient.id %}"
          hx-post="{% url 'patients:document_upload_and_extract' patient_id=patient.id %}"
          hx-encoding="multipart/form-data"
          hx-swap="none"
          class="hidden">
      <input type="file" name="file" accept="application/pdf, text/plain" multiple />
      {% csrf_token %}
    </form>
    <div id="global-upload-hover"
         class="fixed inset-2 rounded-xl pointer-events-none z-50 border-4 border-dashed border-transparent transition-all">
    </div>
  </div>
  <script nonce="{{ request.csp_nonce }}">
    // Wait for the document to be ready
    document.addEventListener('DOMContentLoaded', () => {

      // Get all the elements
      const chatPanel = document.getElementById('mobile-chat-view');
      const chatMessages = chatPanel.querySelector('#chat-messages');
      const chatInput = chatPanel.querySelector("textarea");
      const chatAttach = document.getElementById('chat-attach');
      const chatUserMessageTemplate = chatPanel.querySelector('#user-message-template');
      const chatSubmit = chatPanel.querySelector('#button-id-submit');

      // Mobile navigation
      const mobileNavItems = document.querySelectorAll('.mobile-nav-item');
      const mobileViews = {
        records: document.getElementById('left-panel'),
        chat: document.getElementById('mobile-chat-view'),
        feed: document.getElementById('right-panel'),
      };

      function setActiveView(viewName) {
        // Update view visibility
        Object.values(mobileViews).forEach(view => view.classList.add('hidden'));
        if (mobileViews[viewName]) {
          mobileViews[viewName].classList.remove('hidden');
        }

        // Update nav item styles
        mobileNavItems.forEach(item => {
          const itemView = item.dataset.view;
          const label = item.querySelector('span');
          if (itemView === viewName) {
            item.classList.remove('text-base-content/60');
            item.classList.add('text-primary');
            label.classList.add('font-bold');
          } else {
            item.classList.add('text-base-content/60');
            item.classList.remove('text-primary');
            label.classList.remove('font-bold');
          }
        });
      }

      function handleResize() {
        if (window.innerWidth < 1024) {
          // Find the active view from the nav bar or default to 'chat'
          const activeItem = document.querySelector('.mobile-nav-item.text-primary');
          const activeView = activeItem ? activeItem.dataset.view : 'chat';
          setActiveView(activeView);
        } else {
          // On desktop, show all views
          Object.values(mobileViews).forEach(view => view.classList.remove('hidden'));
        }
      }

      mobileNavItems.forEach(item => {
        item.addEventListener('click', () => {
          setActiveView(item.dataset.view);
        });
      });

      // Define handlers for chat form
      chatSubmit.addEventListener('htmx:beforeRequest', function(event) {
        const message = chatInput.value.trim();
        if (message) {
          addUserMessage(message);
          addAssistantSkeleton();
          chatInputSet('');
        } else {
          event.preventDefault(); // Cancel the request
        }
      });


      document.body.addEventListener('htmx:load', function(event) {
        removeAssistantSkeleton();
        event.target.scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        })

        // attach any event listeners for assistant buttons
        const assistantButtons = chatMessages.querySelectorAll('.assistant-button');
        assistantButtons.forEach(button => {
          if (button.dataset.action === "prompt") {
            button.addEventListener('click', () => {
              chatInputSet(button.dataset.value);
            });
          }
        });
      });

      function addAssistantSkeleton() {
        const skeleton = document.createElement('div');
        skeleton.classList.add('assistant-message', 'chat', 'chat-start', 'my-1', 'assistant-skeleton');
        skeleton.innerHTML = `
            <div class="assistant-message-content chat-bubble p-4 border rounded-lg bg-base-100 text-primary">
              <div class="animate-pulse">
                <div class="h-4 bg-base-300 rounded w-3/4 mb-2"></div>
                <div class="h-4 bg-base-300 rounded w-5/6 mb-2"></div>
                <div class="h-4 bg-base-300 rounded w-1/2"></div>
              </div>
            </div>
          `;
        chatMessages.appendChild(skeleton);
        // Scroll to bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function removeAssistantSkeleton() {
        const skeleton = chatMessages.querySelector('.assistant-skeleton');
        if (skeleton) {
          chatMessages.removeChild(skeleton);
        }
      }

      function addUserMessage(text) {
        const clone = document.importNode(chatUserMessageTemplate.content, true);
        clone.querySelector('.user-message-content').textContent = text;
        chatMessages.appendChild(clone);
      }

      function chatInputSet(value) {
        chatInput.value = value;
        chatInput.focus();
      }

      const hoverIndicator = document.getElementById('global-upload-hover');
      const uploadForm = document.getElementById('global-upload-form');
      const fileInput = uploadForm.querySelector('input');

      // Drag and drop events for the whole window
      window.addEventListener('dragover', e => {
        e.preventDefault();
        hoverIndicator.classList.add('border-primary', 'bg-base-300/50');
        hoverIndicator.classList.remove('border-transparent');
      });
      window.addEventListener('dragleave', e => {
        e.preventDefault();
        hoverIndicator.classList.remove('border-primary', 'bg-base-300/50');
        hoverIndicator.classList.add('border-transparent');
      });
      window.addEventListener('drop', e => {
        e.preventDefault();
        hoverIndicator.classList.remove('border-primary', 'bg-base-300/50');
        hoverIndicator.classList.add('border-transparent');
        const files = e.dataTransfer.files;
        if (!files.length) return;
        const validFiles = Array.from(files).filter(file => ["application/pdf", "text/plain"].includes(file.type));
        if (validFiles.length < files.length) {
          // TODO: add javascript interface for showing toast messages
          alert("Unsupported file type. Please upload a PDF or plain text file.");
          return;
        }
        const dataTransfer = new DataTransfer();
        validFiles.forEach(file => dataTransfer.items.add(file));
        fileInput.files = dataTransfer.files;
        uploadForm.requestSubmit();
      });
      // Manual file selection (optional: add a button if desired)
      fileInput.addEventListener('change', () => {
        uploadForm.requestSubmit();
      });
      chatAttach.addEventListener('click', () => fileInput.click())

      // Set initial state on load and on resize
      window.addEventListener('resize', handleResize);
      handleResize(); // Call on initial load
      chatMessages.scrollTop = chatMessages.scrollHeight;
    });
  </script>
{% endblock body %}
