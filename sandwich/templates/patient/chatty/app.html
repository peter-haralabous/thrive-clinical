{% extends "base.html" %}

{% load crispy_forms_tags %}
{% load lucide %}

{% block body %}
  <div class="grid grid-rows-[auto_1fr_auto] h-screen">
    {% include 'patient/chatty/partials/topnav.html' %}
    <div class="overflow-hidden">
      {# The sse-swap here is misleading; messages include a hx-swap-oob with their real target #}
      <div sse-connect="{% url "core:events" %}?channel=patient/{{ patient.id }}"
           sse-swap="assistant_message,assistant_thinking,user_message,ingest_progress"></div>
      <div id="modal-container"></div>
      <div id="panels-container"
           data-active-view="chat"
           class="flex flex-row gap-0 lg:p-6 h-full overflow-x-hidden">
        {# Left Panel #}
        {% block left_panel %}
          {% include 'patient/chatty/partials/left_panel.html' %}
        {% endblock left_panel %}
        {# Left Resize Handle #}
        <div id="left-resize-handle"
             class="hidden lg:flex items-center justify-center w-2 cursor-col-resize hover:bg-primary/20 transition-colors group">
          <div class="h-12 w-1 bg-base-300 group-hover:bg-primary transition-colors"></div>
        </div>
        {# Center Panel #}
        <div id="mobile-chat-view"
             class="flex-1 lg:flex-1 flex flex-col h-full bg-base-100 rounded-none lg:rounded-xl border-0 lg:border lg:border-base-300">
          <header class="navbar bg-base-100 border-b-0 lg:border-b rounded-none lg:rounded-t-xl">
            <div class="flex-none pl-2">{% lucide "sparkles" class="size-6" %}</div>
            <div class="flex-1 px-2">
              <span class="font-semibold text-lg">Assistant</span>
            </div>
          </header>
          <main id="chat-messages" class="flex-1 overflow-y-auto h-full p-4">
            <template id="user-message-template" class="hidden">
              {% include "patient/chatty/partials/user_message.html" %}
            </template>
            {% for message in chat_messages %}{{ message }}{% endfor %}
          </main>
          <footer class="p-4 bg-base-100 border-t border-base-300 rounded-b-xl flex flex-col items-center">
            {% include 'patient/chatty/partials/chat_form.html' %}
          </footer>
        </div>
        {# Right Resize Handle #}
        <div id="right-resize-handle"
             class="hidden lg:flex items-center justify-center w-2 cursor-col-resize hover:bg-primary/20 transition-colors group">
          <div class="h-12 w-1 bg-base-300 group-hover:bg-primary transition-colors"></div>
        </div>
        {# Right Panel #}
        {% include 'patient/chatty/partials/right_panel.html' %}
      </div>
    </div>
    {# Mobile Navigation #}
    <nav id="mobile-nav"
         class="lg:hidden bg-base-100 border-t border-base-300 flex justify-around shadow-[0_-2px_10px_rgba(0,0,0,0.05)]">
      <button data-view="records"
              class="mobile-nav-item flex flex-col items-center justify-center flex-1 py-2 transition-colors text-base-content/60 hover:text-primary">
        <div class="relative">{% lucide "heart-pulse" class="size-6" %}</div>
        <span class="text-xs font-medium mt-1">Records</span>
      </button>
      <button data-view="chat"
              class="mobile-nav-item flex flex-col items-center justify-center flex-1 py-2 transition-colors text-primary">
        <div class="relative">{% lucide "sparkles" class="size-6" %}</div>
        <span class="text-xs font-bold mt-1">Assistant</span>
      </button>
      <button data-view="feed"
              class="mobile-nav-item flex flex-col items-center justify-center flex-1 py-2 transition-colors text-base-content/60 hover:text-primary">
        <div class="relative">{% lucide "layout-grid" class="size-6" %}</div>
        <span class="text-xs font-medium mt-1">Feed</span>
      </button>
    </nav>
    <form id="global-upload-form"
          method="post"
          action="{% url 'patients:document_upload_and_extract' patient_id=patient.id %}"
          hx-post="{% url 'patients:document_upload_and_extract' patient_id=patient.id %}"
          hx-encoding="multipart/form-data"
          hx-swap="none"
          class="hidden">
      <input type="file" name="file" accept="application/pdf, text/plain" multiple />
      {% csrf_token %}
    </form>
    <div id="global-upload-hover"
         class="fixed inset-2 rounded-xl pointer-events-none z-50 border-4 border-dashed border-transparent transition-all">
    </div>
  </div>
  <script nonce="{{ request.csp_nonce }}">
    // Wait for the document to be ready
    document.addEventListener('DOMContentLoaded', () => {

      // Get all the elements
      const chatPanel = document.getElementById('mobile-chat-view');

      // Guard: Only run this code on the chatty page where these elements exist
      if (!chatPanel) {
        return;
      }

      const chatMessages = chatPanel.querySelector('#chat-messages');
      const chatInput = chatPanel.querySelector("textarea");
      const chatAttach = document.getElementById('chat-attach');
      const chatUserMessageTemplate = chatPanel.querySelector('#user-message-template');

      // Constants
      const MOBILE_BREAKPOINT = 1024; // Tailwind's lg breakpoint

      // Mobile navigation
      const mobileNavItems = document.querySelectorAll('.mobile-nav-item');
      const mobileViews = {
        records: document.getElementById('left-panel'),
        chat: document.getElementById('mobile-chat-view'),
        feed: document.getElementById('right-panel'),
      };

      // Track which panel was last active/focused
      let lastActivePanel = 'chat'; // Default to chat view

      // Add focus tracking to all panels
      function attachPanelListeners() {
        Object.entries(mobileViews).forEach(([viewName, panel]) => {
          if (panel) {
            panel.addEventListener('click', () => {
              lastActivePanel = viewName;
            });
            panel.addEventListener('focusin', () => {
              lastActivePanel = viewName;
            });
          }
        });
      }

      attachPanelListeners();

      /**
       * Sets the active view on mobile and updates navigation UI
       * @param {string} viewName - One of 'records', 'chat', or 'feed'
       */
      function setActiveView(viewName) {
        lastActivePanel = viewName;

        const container = document.getElementById('panels-container');
        if (!container) {
          console.error('panels-container not found');
          return;
        }
        container.setAttribute('data-active-view', viewName);

        // On mobile, hide all panels except the active one
        if (window.innerWidth < MOBILE_BREAKPOINT) {
          const leftPanel = document.getElementById('left-panel');
          const chatPanel = document.getElementById('mobile-chat-view');
          const rightPanel = document.getElementById('right-panel');

          // Hide all panels first
          [leftPanel, chatPanel, rightPanel].forEach(panel => {
            if (panel) {
              panel.classList.add('hidden');
              panel.classList.remove('flex', 'flex-1', 'w-full');
            }
          });

          // Show only the active panel
          let activePanel = null;
          if (viewName === 'records') {
            activePanel = leftPanel;
          } else if (viewName === 'chat') {
            activePanel = chatPanel;
          } else if (viewName === 'feed') {
            activePanel = rightPanel;
          }

          if (activePanel) {
            activePanel.classList.remove('hidden');
            activePanel.classList.add('flex', 'flex-1', 'w-full');
          }
        }

        // Update mobile navigation item styles
        mobileNavItems.forEach(item => {
          const itemView = item.dataset.view;
          const label = item.querySelector('span');
          if (itemView === viewName) {
            item.classList.remove('text-base-content/60');
            item.classList.add('text-primary');
            label.classList.add('font-bold');
          } else {
            item.classList.add('text-base-content/60');
            item.classList.remove('text-primary');
            label.classList.remove('font-bold');
          }
        });
      }

      /**
       * Handles responsive layout changes between mobile and desktop
       */
      function handleResize() {
        if (window.innerWidth < MOBILE_BREAKPOINT) {
          // Mobile: detect which panel to show based on URL or last active panel
          let viewToShow = lastActivePanel;

          // When switching from desktop to mobile, infer view from current URL
          const path = window.location.pathname;
          if (path.includes('/records') || path.includes('/repository')) {
            viewToShow = 'records';
          } else if (path.includes('/feed')) {
            viewToShow = 'feed';
          } else {
            viewToShow = lastActivePanel || 'chat';
          }

          setActiveView(viewToShow);
        } else {
          // Desktop: show all panels side-by-side
          const leftPanel = document.getElementById('left-panel');
          const chatPanel = document.getElementById('mobile-chat-view');
          const rightPanel = document.getElementById('right-panel');

          [leftPanel, chatPanel, rightPanel].forEach(panel => {
            if (panel) {
              panel.classList.remove('hidden', 'w-full');
              panel.classList.add('flex');
            }
          });
        }

        applyPanelWidths();
      }

      // Attach click handlers to mobile navigation items
      mobileNavItems.forEach((item) => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          setActiveView(item.dataset.view);
        });
      });

      // Initialize the active view on page load for mobile
      if (window.innerWidth < MOBILE_BREAKPOINT) {
        setActiveView(lastActivePanel);
      }

      // Define handlers for chat form
      // this would be hx-on, but our CSP blocks that
      document.querySelector("#mobile-chat-view footer").addEventListener("htmx:afterRequest", (event) => {
        if (event.detail.successful) {
          // note: if the backend returns a new empty form to swap in with HTMX the browser
          // will still remember the previous form values and show them if the page is refreshed.
          document.querySelector("#mobile-chat-view footer form").reset();
        }
      });

      document.addEventListener("htmx:oobAfterSwap", (event) => {
        if (event.detail.target?.id === "chat-messages") {
          event.detail.target.children[event.detail.target.children.length - 1]?.scrollIntoView({
            behavior: "smooth"
          });
        }
      });

      const hoverIndicator = document.getElementById('global-upload-hover');
      const uploadForm = document.getElementById('global-upload-form');
      const fileInput = uploadForm.querySelector('input');

      // Drag and drop events for the whole window
      window.addEventListener('dragover', e => {
        e.preventDefault();
        hoverIndicator.classList.add('border-primary', 'bg-base-300/50');
        hoverIndicator.classList.remove('border-transparent');
      });
      window.addEventListener('dragleave', e => {
        e.preventDefault();
        hoverIndicator.classList.remove('border-primary', 'bg-base-300/50');
        hoverIndicator.classList.add('border-transparent');
      });
      window.addEventListener('drop', e => {
        e.preventDefault();
        hoverIndicator.classList.remove('border-primary', 'bg-base-300/50');
        hoverIndicator.classList.add('border-transparent');
        const files = e.dataTransfer.files;
        if (!files.length) return;
        const validFiles = Array.from(files).filter(file => ["application/pdf", "text/plain"].includes(file.type));
        if (validFiles.length < files.length) {
          // TODO: add javascript interface for showing toast messages
          alert("Unsupported file type. Please upload a PDF or plain text file.");
          return;
        }
        const dataTransfer = new DataTransfer();
        validFiles.forEach(file => dataTransfer.items.add(file));
        fileInput.files = dataTransfer.files;
        uploadForm.requestSubmit();
      });
      // Manual file selection (optional: add a button if desired)
      fileInput.addEventListener('change', () => {
        uploadForm.requestSubmit();
      });
      chatAttach.addEventListener('click', () => fileInput.click())

      // Set initial state on load and on resize
      window.addEventListener('resize', handleResize);
      handleResize(); // Call on initial load
      chatMessages.scrollTop = chatMessages.scrollHeight;

      // ===== Panel Resizing =====
      let isResizing = false;
      let currentHandle = null;
      let startX = 0;
      let startWidth = 0;

      function getExpandedPanel(panelId) {
        const container = document.getElementById(panelId);
        if (!container) return null;
        return container.querySelector('.panel-expanded');
      }

      function isPanelCollapsed(panelId) {
        const expandedPanel = getExpandedPanel(panelId);
        return !expandedPanel || expandedPanel.classList.contains('hidden');
      }

      function updateResizeHandleVisibility() {
        const leftResizeHandle = document.getElementById('left-resize-handle');
        const rightResizeHandle = document.getElementById('right-resize-handle');

        // Keep left resize handle as spacer if left panel is collapsed
        if (leftResizeHandle) {
          if (isPanelCollapsed('left-panel')) {
            leftResizeHandle.classList.add('!pointer-events-none', 'opacity-0');
          } else {
            leftResizeHandle.classList.remove('!pointer-events-none', 'opacity-0');
          }
        }

        // Keep right resize handle as spacer if right panel is collapsed
        if (rightResizeHandle) {
          if (isPanelCollapsed('right-panel')) {
            rightResizeHandle.classList.add('!pointer-events-none', 'opacity-0');
          } else {
            rightResizeHandle.classList.remove('!pointer-events-none', 'opacity-0');
          }
        }
      }

      function applyPanelWidths() {
        const leftPanelExpanded = getExpandedPanel('left-panel');
        const rightPanelExpanded = getExpandedPanel('right-panel');
        const centerPanelExpanded = document.querySelector('#mobile-chat-view');

        // Only apply saved widths on desktop
        if (window.innerWidth >= 1024) {
          // Load saved widths from localStorage or use defaults
          const savedLeftWidth = localStorage.getItem('leftPanelWidth') || '320px';
          const savedRightWidth = localStorage.getItem('rightPanelWidth') || '384px';

          // Only apply width if the expanded panel is visible (not collapsed)
          if (leftPanelExpanded && !leftPanelExpanded.classList.contains('hidden')) {
            leftPanelExpanded.style.width = savedLeftWidth;
          }
          if (rightPanelExpanded && !rightPanelExpanded.classList.contains('hidden')) {
            rightPanelExpanded.style.width = savedRightWidth;
          }
        } else {
          // On mobile, ONLY clear inline width styles - don't touch visibility
          // Visibility is managed by setActiveView()
          if (leftPanelExpanded) {
            leftPanelExpanded.style.width = '';
          }
          if (rightPanelExpanded) {
            rightPanelExpanded.style.width = '';
          }
          if (centerPanelExpanded) {
            centerPanelExpanded.style.width = '';
          }
        }

        // Update resize handle visibility based on collapse state
        updateResizeHandleVisibility();
      }

      function startResize(e, handleId) {
        const panelId = handleId === 'left-resize-handle' ? 'left-panel' : 'right-panel';
        const panel = getExpandedPanel(panelId);

        if (!panel || panel.classList.contains('hidden')) return;

        isResizing = true;
        currentHandle = handleId;
        startX = e.clientX;
        startWidth = parseInt(window.getComputedStyle(panel).width);
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
        e.preventDefault();
      }

      function resize(e) {
        if (!isResizing) return;

        const panelId = currentHandle === 'left-resize-handle' ? 'left-panel' : 'right-panel';
        const panel = getExpandedPanel(panelId);

        if (!panel || panel.classList.contains('hidden')) return;

        const dx = currentHandle === 'left-resize-handle' ? (e.clientX - startX) : (startX - e.clientX);
        const newWidth = Math.max(240, Math.min(1200, startWidth + dx)); // Min 240px, Max 1200px

        panel.style.width = newWidth + 'px';
      }

      function stopResize() {
        if (!isResizing) return;

        isResizing = false;
        document.body.style.cursor = '';
        document.body.style.userSelect = '';

        // Save widths to localStorage
        const leftPanelExpanded = getExpandedPanel('left-panel');
        const rightPanelExpanded = getExpandedPanel('right-panel');

        if (leftPanelExpanded && leftPanelExpanded.style.width) {
          localStorage.setItem('leftPanelWidth', leftPanelExpanded.style.width);
        }
        if (rightPanelExpanded && rightPanelExpanded.style.width) {
          localStorage.setItem('rightPanelWidth', rightPanelExpanded.style.width);
        }

        currentHandle = null;
      }

      function setupResizeHandles() {
        const leftResizeHandle = document.getElementById('left-resize-handle');
        const rightResizeHandle = document.getElementById('right-resize-handle');

        // Remove old listeners by cloning (this removes all event listeners)
        if (leftResizeHandle) {
          const newLeftHandle = leftResizeHandle.cloneNode(true);
          leftResizeHandle.parentNode.replaceChild(newLeftHandle, leftResizeHandle);
          newLeftHandle.addEventListener('mousedown', (e) => startResize(e, 'left-resize-handle'));
        }

        if (rightResizeHandle) {
          const newRightHandle = rightResizeHandle.cloneNode(true);
          rightResizeHandle.parentNode.replaceChild(newRightHandle, rightResizeHandle);
          newRightHandle.addEventListener('mousedown', (e) => startResize(e, 'right-resize-handle'));
        }
      }

      // Initial setup
      applyPanelWidths();
      setupResizeHandles();

      // Global mouse move and up events
      document.addEventListener('mousemove', resize);
      document.addEventListener('mouseup', stopResize);

      // Reapply widths after HTMX swaps
      document.body.addEventListener('htmx:afterSwap', function(event) {
        // Check if this was an outerHTML swap of one of our panels
        // Note: event.detail.xhr may be undefined for history restores or cached swaps
        const swapType = (event.detail.xhr?.getResponseHeader('HX-Reswap')) ||
          event.detail.elt.getAttribute('hx-swap') || 'innerHTML';

        if (swapType === 'outerHTML') {
          // Re-query the panel elements since they were replaced
          mobileViews.records = document.getElementById('left-panel');
          mobileViews.chat = document.getElementById('mobile-chat-view');
          mobileViews.feed = document.getElementById('right-panel');

          // Re-attach listeners to the new elements
          attachPanelListeners();
        }

        // Apply panel widths after a small delay
        setTimeout(() => {
          applyPanelWidths();
        }, 0);
      });

      /**
       * Re-apply mobile view state after HTMX content swaps
       * This ensures panels stay in correct visibility state after dynamic updates
       */
      document.body.addEventListener('htmx:afterSettle', function(event) {
        if (!event.detail || !event.detail.target) {
          return;
        }

        const swapTarget = event.detail.target;

        // Re-apply visibility in mobile mode after content swaps
        // innerHTML swaps can replace elements and remove our visibility classes
        if (window.innerWidth < MOBILE_BREAKPOINT) {
          const targetId = swapTarget.id || '';

          // Determine which panel was affected by the swap
          let swappedPanel = null;
          if (targetId === 'left-panel' || (swapTarget.closest && swapTarget.closest('#left-panel'))) {
            swappedPanel = 'records';
          } else if (targetId === 'mobile-chat-view' || (swapTarget.closest && swapTarget.closest('#mobile-chat-view'))) {
            swappedPanel = 'chat';
          } else if (targetId === 'right-panel' || (swapTarget.closest && swapTarget.closest('#right-panel'))) {
            swappedPanel = 'feed';
          } else if (targetId === 'modal-container' || (swapTarget.closest && swapTarget.closest('#modal-container'))) {
            // Modal opened/closed - re-apply active view to ensure correct visibility
            requestAnimationFrame(() => {
              setActiveView(lastActivePanel);
            });
            return;
          }

          // Re-apply if the swapped panel matches the active panel or is unknown
          if (swappedPanel === lastActivePanel || swappedPanel === null) {
            // Use requestAnimationFrame to ensure DOM is fully rendered before applying classes
            requestAnimationFrame(() => {
              setActiveView(lastActivePanel);
            });
          }
        }
      });

      // Update resize handle visibility when panels are toggled
      document.body.addEventListener('toggle-children', function(event) {
        setTimeout(() => {
          updateResizeHandleVisibility();
        }, 0);
      });

    });
  </script>
{% endblock body %}
