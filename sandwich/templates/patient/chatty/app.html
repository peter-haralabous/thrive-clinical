{% extends "base.html" %}

{% load crispy_forms_tags %}
{% load lucide %}

{% block body %}
  <div class="grid grid-rows-[auto_1fr_auto] h-screen"
       sse-connect="{% url "core:events" %}?channel=patient/{{ patient.id }}">
    {% include 'patient/chatty/partials/topnav.html' %}
    <div class="overflow-hidden">
      {# The sse-swap here is misleading; messages include a hx-swap-oob with their real target #}
      <div sse-swap="assistant_message,assistant_thinking,user_message,feed_item"></div>
      <div class="flex flex-row gap-2 p-1 lg:p-6 h-full">
        {# Left Panel #}
        {% block left_panel %}
          {% include 'patient/chatty/partials/left_panel.html' %}
        {% endblock left_panel %}
        {# Center Panel #}
        <div id="mobile-chat-view"
             class="w-full lg:w-auto lg:flex-1 flex flex-col h-full bg-base-100 rounded-xl border border-base-300">
          <header class="navbar bg-base-100 border-b rounded-t-xl">
            <div class="flex-none pl-2">{% lucide "sparkles" class="size-6" %}</div>
            <div class="flex-1 px-2">
              <span class="font-semibold text-lg">Assistant</span>
            </div>
            <div class="flex-none pr-2">
              <div class="dropdown dropdown-end">
                <button tabindex="0" role="button" class="btn btn-ghost btn-sm btn-square">
                  {% lucide "ellipsis-vertical" class="size-5" %}
                </button>
                <ul tabindex="0"
                    class="dropdown-content menu bg-base-100 rounded-box z-[1] w-52 p-2 shadow-lg border border-base-300">
                  <li>
                    <button hx-post="{% url 'patients:clear_chat' patient_id=patient.id %}"
                            hx-confirm="Are you sure you want to clear your chat history? This cannot be undone."
                            class="text-error">
                      {% lucide "trash-2" class="size-4" %}
                      Clear my chat
                    </button>
                  </li>
                </ul>
              </div>
            </div>
          </header>
          <main id="chat-messages" class="flex-1 overflow-y-auto h-full p-4">
            {% for message in chat_messages %}{{ message }}{% endfor %}
          </main>
          <footer class="p-4 bg-base-100 border-t border-base-300 rounded-b-xl flex flex-col items-center">
            {% include 'patient/chatty/partials/chat_form.html' %}
          </footer>
        </div>
        {# Right Panel #}
        {% include 'patient/chatty/partials/right_panel.html' %}
      </div>
    </div>
    {# Mobile Navigation #}
    <nav id="mobile-nav"
         class="lg:hidden bg-base-100 border-t border-base-300 flex justify-around shadow-[0_-2px_10px_rgba(0,0,0,0.05)]">
      <button data-view="records"
              class="mobile-nav-item flex flex-col items-center justify-center flex-1 py-2 transition-colors text-base-content/60 hover:text-primary">
        <div class="relative">{% lucide "heart-pulse" class="size-6" %}</div>
        <span class="text-xs font-medium mt-1">Records</span>
      </button>
      <button data-view="chat"
              class="mobile-nav-item flex flex-col items-center justify-center flex-1 py-2 transition-colors text-primary">
        <div class="relative">{% lucide "sparkles" class="size-6" %}</div>
        <span class="text-xs font-bold mt-1">Assistant</span>
      </button>
      <button data-view="feed"
              class="mobile-nav-item flex flex-col items-center justify-center flex-1 py-2 transition-colors text-base-content/60 hover:text-primary">
        <div class="relative">{% lucide "layout-grid" class="size-6" %}</div>
        <span class="text-xs font-medium mt-1">Feed</span>
      </button>
    </nav>
    <form id="global-upload-form"
          method="post"
          action="{% url 'patients:document_upload_and_extract' patient_id=patient.id %}"
          hx-post="{% url 'patients:document_upload_and_extract' patient_id=patient.id %}"
          hx-encoding="multipart/form-data"
          hx-swap="none"
          class="hidden">
      <input type="file" name="file" accept="application/pdf, text/plain" multiple />
      <input type="hidden" name="context" value="{{ document_context }}" />
      {% csrf_token %}
    </form>
    <div id="global-upload-hover"
         class="fixed inset-2 rounded-xl pointer-events-none z-50 border-4 border-dashed border-transparent transition-all">
    </div>
  </div>
  <script nonce="{{ request.csp_nonce }}">
    // Wait for the document to be ready
    document.addEventListener('DOMContentLoaded', () => {

      // Get all the elements
      const chatPanel = document.getElementById('mobile-chat-view');
      const chatMessages = chatPanel.querySelector('#chat-messages');
      const chatInput = chatPanel.querySelector("textarea");
      const chatAttach = document.getElementById('chat-attach');



      // Mobile navigation
      const mobileNavItems = document.querySelectorAll('.mobile-nav-item');
      const mobileViews = {
        records: document.getElementById('left-panel'),
        chat: document.getElementById('mobile-chat-view'),
        feed: document.getElementById('right-panel'),
      };

      function setActiveView(viewName) {
        // Update view visibility
        Object.values(mobileViews).forEach(view => view.classList.add('hidden'));
        if (mobileViews[viewName]) {
          mobileViews[viewName].classList.remove('hidden');
        }

        // Update nav item styles
        mobileNavItems.forEach(item => {
          const itemView = item.dataset.view;
          const label = item.querySelector('span');
          if (itemView === viewName) {
            item.classList.remove('text-base-content/60');
            item.classList.add('text-primary');
            label.classList.add('font-bold');
          } else {
            item.classList.add('text-base-content/60');
            item.classList.remove('text-primary');
            label.classList.remove('font-bold');
          }
        });
      }

      function handleResize() {
        if (window.innerWidth < 1024) {
          // Find the active view from the nav bar or default to 'chat'
          const activeItem = document.querySelector('.mobile-nav-item.text-primary');
          const activeView = activeItem ? activeItem.dataset.view : 'chat';
          setActiveView(activeView);
        } else {
          // On desktop, show all views
          Object.values(mobileViews).forEach(view => view.classList.remove('hidden'));
        }
      }

      mobileNavItems.forEach(item => {
        item.addEventListener('click', () => {
          setActiveView(item.dataset.view);
        });
      });

      // Define handlers for chat form
      // this would be hx-on, but our CSP blocks that
      document.querySelector("#mobile-chat-view footer").addEventListener("htmx:afterRequest", (event) => {
        if (event.detail.successful) {
          // note: if the backend returns a new empty form to swap in with HTMX the browser
          // will still remember the previous form values and show them if the page is refreshed.
          document.querySelector("#mobile-chat-view footer form").reset();
        }
      });

      document.addEventListener("htmx:oobBeforeSwap", (event) => {
        // Listen for out-of-band swaps that have the data-hx-swap-oob-replace-if-exists attribute
        const replaceTargetId = event.detail.fragment.dataset.hxSwapOobReplaceIfExists;
        if (replaceTargetId) {
          const existingElement = document.getElementById(replaceTargetId)
          const newElement = event.detail.fragment.querySelector(`#${replaceTargetId}`)
          if (newElement && existingElement) {
            // Replace existing item instead of adding a duplicate
            existingElement.replaceWith(newElement);
            // Prevent default swap behavior
            event.detail.shouldSwap = false;
          }
        }
      });

      document.addEventListener("htmx:oobAfterSwap", (event) => {
        if (event.detail.target?.id === "chat-messages") {
          event.detail.target.children[event.detail.target.children.length - 1]?.scrollIntoView({
            behavior: "smooth"
          });
        }
      });

      const hoverIndicator = document.getElementById('global-upload-hover');
      const uploadForm = document.getElementById('global-upload-form');
      const fileInput = uploadForm.querySelector('input');
      const fileInputHeader = document.getElementById('file-upload-card-header');

      // Drag and drop events for the whole window
      window.addEventListener('dragover', e => {
        e.preventDefault();
        hoverIndicator.classList.add('border-primary', 'bg-base-300/50');
        hoverIndicator.classList.remove('border-transparent');
      });
      window.addEventListener('dragleave', e => {
        e.preventDefault();
        hoverIndicator.classList.remove('border-primary', 'bg-base-300/50');
        hoverIndicator.classList.add('border-transparent');
      });
      window.addEventListener('drop', e => {
        e.preventDefault();
        hoverIndicator.classList.remove('border-primary', 'bg-base-300/50');
        hoverIndicator.classList.add('border-transparent');
        const files = e.dataTransfer.files;
        if (!files.length) return;
        const validFiles = Array.from(files).filter(file => ["application/pdf", "text/plain"].includes(file.type));
        if (validFiles.length < files.length) {
          // TODO: add javascript interface for showing toast messages
          alert("Unsupported file type. Please upload a PDF or plain text file.");
          return;
        }
        const dataTransfer = new DataTransfer();
        validFiles.forEach(file => dataTransfer.items.add(file));
        fileInput.files = dataTransfer.files;
        uploadForm.requestSubmit();
      });
      // Manual file selection (optional: add a button if desired)
      fileInputHeader.addEventListener("click", () => fileInput.click());
      fileInput.addEventListener('change', () => {
        uploadForm.requestSubmit();
      });
      chatAttach.addEventListener('click', () => fileInput.click())

      // Set initial state on load and on resize
      window.addEventListener('resize', handleResize);
      handleResize(); // Call on initial load
      chatMessages.scrollTop = chatMessages.scrollHeight;
    });
  </script>
{% endblock body %}
