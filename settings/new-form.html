<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>New Form Template - Thrive Clinical</title>
    <script type="module" src="../shared/global-header.js"></script>
    <link rel="stylesheet" href="../shared/styles.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@300;400;500;600;700"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- SurveyJS Form Library resources -->
    <link
      href="https://unpkg.com/survey-core/survey-core.min.css"
      type="text/css"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/survey-core/survey.core.min.js"></script>
    <script src="https://unpkg.com/survey-js-ui/survey-js-ui.min.js"></script>

    <!-- (Optional) Predefined theme configurations -->
    <script src="https://unpkg.com/survey-core/themes/index.min.js"></script>

    <!-- Survey Creator resources -->
    <link
      href="https://unpkg.com/survey-creator-core/survey-creator-core.min.css"
      type="text/css"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/survey-creator-core/survey-creator-core.min.js"></script>
    <script src="https://unpkg.com/survey-creator-js/survey-creator-js.min.js"></script>

    <style>
      main {
        margin-left: 256px;
        padding-top: 0px;
        min-height: 100vh;
        background: #f8f9fa;
      }

      .content-area {
        max-width: 100%;
        padding: 32px;
        height: calc(100vh - 64px);
      }

      .page-title-section {
        margin-bottom: 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .page-title-section h1 {
        font-size: 28px;
        font-weight: 700;
        color: #0b1220;
      }

      .btn-secondary {
        background: #ffffff;
        color: #0f172a;
        border: 1px solid #d1d5db;
        padding: 10px 16px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        font-size: 14px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        text-decoration: none;
      }

      .btn-secondary:hover {
        background: #f9fafb;
      }

      .btn-primary {
        background: #0f172a;
        color: #ffffff;
        border: none;
        padding: 10px 16px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        font-size: 14px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        text-decoration: none;
        margin-left: 8px;
      }

      .btn-primary:hover {
        background: #1e293b;
      }

      .actions-group {
        display: flex;
        gap: 8px;
      }

      #surveyCreator {
        height: calc(100vh - 180px);
        width: 100%;
      }
    </style>
  </head>
  <body>
    <global-header home-url="../index.html" base-path=".."></global-header>

    <!-- Fixed Left Sidebar -->
    <aside
      class="w-64 bg-white border-r border-gray-200 flex-shrink-0 fixed left-0 top-16 h-screen z-30 flex flex-col overflow-y-auto"
    >
      <div class="p-4">
        <div class="mb-4 pb-3 border-b border-gray-200">
          <p class="text-base font-semibold text-gray-900" id="sidebarOrgName">
            Valley Health Clinic
          </p>
        </div>
        <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-3">Settings</h2>
        <nav class="space-y-1">
          <a
            href="./organization-settings.html"
            class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-100 font-medium text-sm"
          >
            <span class="material-symbols-outlined text-lg text-gray-600">apartment</span>
            Organization Profile
          </a>
          <a
            href="./worklist-preferences.html"
            class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-100 font-medium text-sm"
          >
            <span class="material-symbols-outlined text-lg text-gray-600">list</span>
            Worklist Preferences
          </a>
          <a
            href="./custom-fields.html"
            class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-100 font-medium text-sm"
          >
            <span class="material-symbols-outlined text-lg text-gray-600">tune</span>
            Custom Fields
          </a>
          <a
            href="./form-templates.html"
            class="flex items-center gap-3 px-3 py-2 rounded-lg bg-gray-900 text-white font-medium text-sm"
          >
            <span class="material-symbols-outlined text-lg">description</span>
            Form Templates
          </a>
          <a
            href="./summary-templates.html"
            class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-100 font-medium text-sm"
          >
            <span class="material-symbols-outlined text-lg text-gray-600">summarize</span>
            Summary Templates
          </a>
          <a
            href="./automations.html"
            class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-100 font-medium text-sm"
          >
            <span class="material-symbols-outlined text-lg text-gray-600">automation</span>
            Automations
          </a>
        </nav>
      </div>
    </aside>

    <!-- Main Content -->
    <main>
      <div class="content-area">
        <div class="page-title-section">
          <h1>New Form Template</h1>
          <div class="actions-group">
            <a href="./form-templates.html" class="btn-secondary">
              <span class="material-symbols-outlined" style="font-size: 18px">close</span>
              Cancel
            </a>
            <button class="btn-primary" onclick="saveForm()">
              <span class="material-symbols-outlined" style="font-size: 18px">save</span>
              Save Form
            </button>
          </div>
        </div>

        <div id="surveyCreator"></div>
      </div>
    </main>

    <script>
      function toggleDropdown() {
        const dropdown = document.getElementById('userDropdown');
        dropdown.classList.toggle('show');
      }

      document.addEventListener('click', function (event) {
        const dropdown = document.getElementById('userDropdown');
        const avatarBtn = document.getElementById('userAvatarBtn');

        if (!dropdown.contains(event.target) && !avatarBtn.contains(event.target)) {
          dropdown.classList.remove('show');
        }
      });

      // Initialize SurveyJS Creator
      const creatorOptions = {
        showLogicTab: true,
        showTranslationTab: true,
        isAutoSave: true,
      };

      const creator = new SurveyCreator.SurveyCreator(creatorOptions);

      // Default patient intake form template
      const defaultFormJSON = {
        title: 'Sample Clinical Questionnaire',
        pages: [
          {
            name: 'patient_demographics',
            title: 'Patient Demographics',
            elements: [
              {
                type: 'text',
                name: 'full_name',
                title: 'Full Name',
                isRequired: true,
              },
              {
                type: 'text',
                name: 'date_of_birth',
                title: 'Date of Birth',
                isRequired: true,
                inputType: 'date',
              },
              {
                type: 'radiogroup',
                name: 'sex_gender',
                title: 'Sex / Gender',
                isRequired: true,
                showCommentArea: true,
                choices: ['Female', 'Male', 'Non-binary', 'Prefer not to say', 'Self-describe'],
              },
              {
                type: 'text',
                name: 'phn',
                title: 'Provincial Health Number (PHN)',
              },
              {
                type: 'text',
                name: 'mrn',
                title: 'Medical Record Number (MRN)',
              },
              {
                type: 'dropdown',
                name: 'preferred_language',
                title: 'Preferred Language',
                choices: [
                  'English',
                  'French',
                  'Mandarin',
                  'Cantonese',
                  'Punjabi',
                  'Arabic',
                  'Spanish',
                  'Other',
                ],
              },
              {
                type: 'boolean',
                name: 'communication_assistance',
                title: 'Communication Assistance Needed?',
              },
              {
                type: 'text',
                name: 'height',
                title: 'Height (in inches)',
                inputType: 'number',
                validators: [
                  {
                    type: 'numeric',
                    minValue: 24,
                    maxValue: 96,
                    text: 'Please enter a valid height between 24 and 96 inches',
                  },
                ],
              },
              {
                type: 'text',
                name: 'weight',
                title: 'Weight (in pounds)',
                inputType: 'number',
                validators: [
                  {
                    type: 'numeric',
                    minValue: 10,
                    maxValue: 1000,
                    text: 'Please enter a valid weight between 10 and 1000 pounds',
                  },
                ],
              },
              {
                type: 'text',
                name: 'bmiScore',
                title: 'BMI Score',
                inputType: 'number',
                readOnly: true,
              },
              {
                type: 'paneldynamic',
                name: 'emergency_contact',
                title: 'Emergency Contact',
                templateElements: [
                  {
                    type: 'text',
                    name: 'contact_name',
                    title: 'Name',
                  },
                  {
                    type: 'text',
                    name: 'relationship',
                    title: 'Relationship',
                  },
                  {
                    type: 'text',
                    name: 'phone_number',
                    title: 'Phone number',
                    inputType: 'tel',
                  },
                ],
                addPanelText: 'Add Emergency Contact',
                removePanelText: 'Remove',
              },
            ],
          },
          {
            name: 'active_medical_conditions',
            title: 'Active Medical Conditions',
            elements: [
              {
                type: 'tagbox',
                name: 'question1',
                title: 'Active Medical Conditions (Diagnosed or Under Evaluation)',
                choices: [
                  'Hypertension',
                  'Diabetes (Type 1 or Type 2)',
                  'COPD / Asthma',
                  'Coronary artery disease',
                  'Chronic kidney disease',
                  'Dementia / cognitive impairment',
                  'Depression / anxiety',
                  'Current infection (e.g., pneumonia, UTI)',
                  'Musculoskeletal pain',
                  'Other',
                  'No active conditions',
                ],
              },
              {
                type: 'comment',
                name: 'active_conditions_details',
                visibleIf:
                  "{active_medical_conditions} notempty and {active_medical_conditions} notcontains 'No active conditions'",
                title: 'Describe details or context for these active conditions',
              },
            ],
          },
          {
            name: 'past_medical_history',
            title: 'Past Medical History',
            elements: [
              {
                type: 'tagbox',
                name: 'past_medical_conditions',
                title: 'Past Medical Conditions (Resolved or Historical)',
                choices: [
                  'Hypertension',
                  'Diabetes',
                  'Depression',
                  'Asthma',
                  'Previous fractures',
                  'Cancer',
                  'Stroke',
                  'Heart attack',
                  'None',
                  'Other',
                ],
              },
              {
                type: 'comment',
                name: 'past_conditions_details',
                visibleIf:
                  "{past_medical_conditions} notempty and {past_medical_conditions} notcontains 'None'",
                title: 'Additional PMH details',
              },
              {
                type: 'paneldynamic',
                name: 'past_surgeries',
                title: 'Past Surgeries',
                templateElements: [
                  {
                    type: 'text',
                    name: 'procedure',
                    title: 'Procedure',
                  },
                  {
                    type: 'dropdown',
                    name: 'laterality',
                    title: 'Laterality',
                    choices: ['left', 'right', 'bilateral', 'not applicable'],
                  },
                  {
                    type: 'text',
                    name: 'approximate_date',
                    title: 'Approximate date',
                    inputType: 'date',
                  },
                  {
                    type: 'boolean',
                    name: 'complications',
                    title: 'Complications?',
                  },
                  {
                    type: 'text',
                    name: 'additional_notes',
                    title: 'Additional notes',
                  },
                ],
                addPanelText: 'Add Surgery',
                removePanelText: 'Remove',
              },
            ],
          },
          {
            name: 'allergies_medications',
            title: 'Allergies and Medications',
            elements: [
              {
                type: 'paneldynamic',
                name: 'allergies',
                title: 'Allergies',
                templateElements: [
                  {
                    type: 'text',
                    name: 'allergen',
                    title: 'Allergen',
                  },
                  {
                    type: 'text',
                    name: 'reaction_description',
                    title: 'Reaction description',
                  },
                  {
                    type: 'dropdown',
                    name: 'severity',
                    title: 'Severity',
                    choices: ['mild', 'moderate', 'severe', 'unknown'],
                  },
                ],
                addPanelText: 'Add Allergy',
                removePanelText: 'Remove',
              },
              {
                type: 'checkbox',
                name: 'no_known_allergies',
                title: 'If no allergies, check below',
                choices: ['No known allergies (NKA)'],
              },
              {
                type: 'paneldynamic',
                name: 'medication_list',
                title: 'Medication List',
                templateElements: [
                  {
                    type: 'text',
                    name: 'medication_name',
                    title: 'Medication name',
                  },
                  {
                    type: 'text',
                    name: 'dose',
                    title: 'Dose',
                    inputType: 'number',
                  },
                  {
                    type: 'dropdown',
                    name: 'route',
                    title: 'Route',
                    choices: ['PO', 'SC', 'IV', 'IM', 'topical', 'inhaled', 'other'],
                  },
                  {
                    type: 'dropdown',
                    name: 'frequency',
                    title: 'Frequency',
                    choices: ['once daily', 'twice daily', 'three times daily', 'PRN', 'other'],
                  },
                  {
                    type: 'text',
                    name: 'notes',
                    title: 'Notes',
                  },
                ],
                addPanelText: 'Add Medication',
                removePanelText: 'Remove',
              },
              {
                type: 'file',
                name: 'medication_list_upload',
                title: 'Upload medication list (optional)',
              },
            ],
          },
          {
            name: 'immunizations_social_history',
            title: 'Immunizations and Social History',
            elements: [
              {
                type: 'tagbox',
                name: 'immunizations_received',
                title: 'Immunizations Received',
                choices: [
                  'Influenza',
                  'COVID-19',
                  'Pneumococcal',
                  'Tetanus',
                  'Shingles',
                  'Hepatitis B',
                  'Childhood series (MMR, DTaP, polio, etc.)',
                  'Unknown',
                  'None',
                ],
              },
              {
                type: 'radiogroup',
                name: 'tobacco_use',
                title: 'Tobacco Use',
                choices: ['Current', 'Former', 'Never', 'Unknown'],
              },
              {
                type: 'dropdown',
                name: 'alcohol_use',
                title: 'Alcohol Use',
                choices: ['None', 'Occasional', 'Moderate', 'Heavy', 'Unknown'],
              },
              {
                type: 'checkbox',
                name: 'recreational_drug_use',
                title: 'Recreational Drug Use',
                choices: [
                  'Cannabis',
                  'Opioids',
                  'Cocaine',
                  'Methamphetamines',
                  'Other substances',
                  'None',
                  'Unknown',
                ],
              },
              {
                type: 'dropdown',
                name: 'living_situation',
                title: 'Living Situation',
                choices: [
                  'Lives alone',
                  'Lives with family',
                  'Assisted living',
                  'Long-term care',
                  'Homeless/unstable housing',
                  'Unknown',
                ],
              },
              {
                type: 'comment',
                name: 'occupation_work_exposures',
                title: 'Occupation / Work exposures',
              },
              {
                type: 'comment',
                name: 'lifestyle_details',
                title: 'Diet, exercise, travel, or other relevant lifestyle details',
              },
            ],
          },
          {
            name: 'family_history',
            title: 'Family History',
            elements: [
              {
                type: 'tagbox',
                name: 'relevant_family_conditions',
                title: 'Relevant Family Conditions',
                choices: [
                  'Cardiovascular disease (MI, stroke, HTN)',
                  'Diabetes',
                  'Cancers',
                  'Genetic disorders',
                  'Psychiatric conditions',
                  'None',
                  'Unknown',
                  'Other',
                ],
              },
              {
                type: 'comment',
                name: 'family_history_details',
                title: 'Additional family history details',
              },
            ],
          },
          {
            name: 'tests_specialists',
            title: 'Recent Tests and Specialists',
            elements: [
              {
                type: 'paneldynamic',
                name: 'recent_tests',
                title: 'Recent Tests',
                templateElements: [
                  {
                    type: 'text',
                    name: 'test_date',
                    title: 'Test date',
                    inputType: 'date',
                  },
                  {
                    type: 'dropdown',
                    name: 'test_type',
                    title: 'Test type',
                    choices: ['Labs', 'Imaging', 'Diagnostics', 'Other'],
                  },
                  {
                    type: 'text',
                    name: 'test_description',
                    title: 'Description of test',
                  },
                  {
                    type: 'comment',
                    name: 'key_findings',
                    title: 'Key findings',
                  },
                  {
                    type: 'file',
                    name: 'attach_report',
                    title: 'Attach report',
                  },
                ],
                addPanelText: 'Add Test',
                removePanelText: 'Remove',
              },
              {
                type: 'paneldynamic',
                name: 'specialists_involved',
                title: 'Specialists Involved',
                templateElements: [
                  {
                    type: 'dropdown',
                    name: 'specialist_type',
                    title: 'Specialist type',
                    choices: [
                      'cardiology',
                      'endocrinology',
                      'nephrology',
                      'psychiatry',
                      'geriatrics',
                      'surgery',
                      'other',
                    ],
                  },
                  {
                    type: 'comment',
                    name: 'reason_for_involvement',
                    title: 'Reason for involvement',
                  },
                  {
                    type: 'dropdown',
                    name: 'status',
                    title: 'Status',
                    choices: ['active', 'intermittent', 'unknown'],
                  },
                ],
                addPanelText: 'Add Specialist',
                removePanelText: 'Remove',
              },
            ],
          },
          {
            name: 'care_plans_preferences',
            title: 'Care Plans and Preferences',
            elements: [
              {
                type: 'checkbox',
                name: 'current_care_plans',
                title: 'Current Care Plans or Pathways',
                choices: [
                  'COPD action plan',
                  'Diabetes management plan',
                  'Fall prevention plan',
                  'Cardiac rehab',
                  'Wound care plan',
                  'Physiotherapy / OT',
                  'Pain management plan',
                  'None',
                  'Other',
                ],
              },
              {
                type: 'comment',
                name: 'care_plan_details',
                title: 'Care plan details',
              },
              {
                type: 'comment',
                name: 'preferences_for_care',
                title: 'Preferences for care or communication',
              },
              {
                type: 'ranking',
                name: 'preference_ranking',
                title: 'Preference Ranking (optional)',
                choices: [
                  'Appointment times',
                  'Involvement of family',
                  'Communication method',
                  'Home vs clinic care',
                  'Medication burden',
                  'Lifestyle-focused care',
                ],
              },
            ],
          },
          {
            name: 'signature_completion',
            title: 'Signature and Completion',
            elements: [
              {
                type: 'signaturepad',
                name: 'signature',
                title: 'Signature',
              },
              {
                type: 'text',
                name: 'encounter_date',
                title: 'Encounter Date',
                inputType: 'datetime-local',
              },
            ],
          },
        ],
        triggers: [
          {
            type: 'runexpression',
            expression: '{height} notempty and {weight} notempty',
            runExpression: '({weight} * 703) / ({height} * {height})',
            setToName: 'bmiScore',
          },
        ],
      };

      // Always load the default form (for prototype purposes)
      creator.text = JSON.stringify(defaultFormJSON);

      creator.saveSurveyFunc = (saveNo, callback) => {
        window.localStorage.setItem('survey-json', creator.text);
        callback(saveNo, true);
        console.log('Form saved!');
      };

      creator.render('surveyCreator');

      function saveForm() {
        // Save the form JSON to localStorage
        window.localStorage.setItem('survey-json', creator.text);
        // Redirect back to form templates page
        window.location.href = './form-templates.html';
      }
    </script>
  </body>
</html>
