# Emails

The emails generated by the application make use of the `Template` model to allow for configuration of the templates
outside the release cycle

See Also:
  - https://docs.djangoproject.com/en/stable/ref/templates/builtins
  - https://docs.djangoproject.com/en/stable/howto/custom-template-tags/
  - https://docs.djangoproject.com/en/stable/ref/templates/builtins/#debug
    - The addition of the `debug` template tag can be useful for inspecting the context passed to a template
  - [`manage template render`](../sandwich/core/management/commands/template.py)
    - The template management command has an option to render a template and send to the email service

## Organization templates (Future)

Because the templates can be associated with organizations, it will (in the future) be possible to author templates that
might want to be different in different environments (e.g. staging vs production) or for different customers. These
will need more design around authoring and promotion.

## System templates

Some templates (like `email/base`) are not associated with any organization. These are used for system emails like
password resets and the like. These templates should be committed to the repo and deployed via a data migration. See 
[0015_update_templates](../sandwich/core/migrations/0015_update_templates.py) for an example

## `allauth`

Account management emails are generated from the `django-allauth` package. Some basic info can be found in the [docs](https://django-allauth.readthedocs.io/en/latest/common/email.html)


We have [configured](../sandwich/users/adapters.py) the package to use only HTML emails and to use templates stored in the database (if they are defined)
    
The names of the templates that the package uses can be found in the [source repo](https://codeberg.org/allauth/django-allauth/src/branch/main/allauth/templates/account/email)  

> [!IMPORTANT]
> The Template instances should have organization set to `None` and the slug set to the name of the template as defined in the repo (including the `.txt` suffix)

The following templates would configure both the subject and body of password reset emails:

```python
from sandwich.core.models import Template

Template(
    organization=None,
    slug="account/email/password_reset_subject.txt",
    content="Your HealthConnect password has been reset",
).save()

Template(
    organization=None,
    slug="account/email/password_reset_message.txt",
    content="""
# Your HealthConnect password has been reset

If this wasn't you, you got hacked! Please contact support immediately.

Have a great day!
    """,
).save()

```

## `send_templated_email`

The [send_templated_email](../sandwich/core/service/email_service.py) function can be used to send emails using Templates stored in the database.
